<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Model Viewer – Hand Scale (No Parallax)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: -apple-system, system-ui;
  color: #00ffcc;
}
canvas { display:block; }

/* UI */
#ui {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(0,0,0,0.85);
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #333;
  font-size: 12px;
  z-index: 10;
}

/* Loading */
#loading {
  position: fixed;
  inset: 0;
  background: black;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #333;
  border-top: 4px solid #00ffcc;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Webcam preview */
#v-prev {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 140px;
  opacity: 0.4;
  border: 1px solid #00ffcc;
  border-radius: 8px;
  transform: scaleX(-1);
}

/* Hand dots */
.hand-dot {
  position: fixed;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #00ffcc;
  box-shadow: 0 0 12px #00ffcc;
  pointer-events: none;
  transform: translate(-50%, -50%);
  display: none;
  z-index: 50;
}
</style>
</head>

<body>

<div id="loading"><div class="spinner"></div></div>

<div id="ui">
  <b>NORMAL MODEL VIEW</b><br>
  Hand scale enabled<br>
  <span id="debug">Waiting for hands…</span>
</div>

<video id="webcam" autoplay playsinline style="display:none"></video>
<video id="v-prev" autoplay playsinline></video>

<div id="dotL" class="hand-dot"></div>
<div id="dotR" class="hand-dot"></div>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from "three";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { HandLandmarker, FilesetResolver }
  from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7";

/* ───────── THREE SETUP ───────── */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* Fixed, normal camera */
const camera = new THREE.PerspectiveCamera(
  45,
  innerWidth / innerHeight,
  0.1,
  1000
);
camera.position.set(0, 0, 80);

/* Lighting */
scene.add(new THREE.DirectionalLight(0xffffff, 2).position.set(10,20,20));
scene.add(new THREE.AmbientLight(0xffffff, 0.6));

/* Optional ground grid */
const grid = new THREE.GridHelper(200, 20, 0x00ffcc, 0x222222);
grid.position.y = -25;
scene.add(grid);

/* ───────── LOAD MODEL ───────── */

let model;
let baseScale = 1;
let targetScale = 1;
let smoothScale = 1;

new GLTFLoader().load("model.glb", gltf => {
  model = gltf.scene;

  const box = new THREE.Box3().setFromObject(model);
  const size = box.getSize(new THREE.Vector3()).length();
  baseScale = 30 / size;

  model.scale.setScalar(baseScale);
  box.getCenter(model.position).multiplyScalar(-1);

  scene.add(model);
  document.getElementById("loading").style.display = "none";
});

/* ───────── HAND TRACKING ───────── */

const video = document.getElementById("webcam");
const dotL = document.getElementById("dotL");
const dotR = document.getElementById("dotR");

let handLandmarker;
let baselineDist = null;

async function initHands() {
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode: "VIDEO",
    numHands: 2
  });

  const stream = await navigator.mediaDevices.getUserMedia({ video:true });
  video.srcObject = document.getElementById("v-prev").srcObject = stream;

  video.onloadeddata = () => {
    trackHands();
    animate();
  };
}

function updateDot(dot, lm) {
  dot.style.left = `${lm.x * innerWidth}px`;
  dot.style.top  = `${lm.y * innerHeight}px`;
  dot.style.display = "block";
}

function trackHands() {
  const res = handLandmarker.detectForVideo(video, performance.now());

  if (res.landmarks && res.landmarks.length === 2) {
    const a = res.landmarks[0][8]; // index tip
    const b = res.landmarks[1][8];

    updateDot(dotL, a);
    updateDot(dotR, b);

    const d = Math.hypot(a.x - b.x, a.y - b.y);
    if (!baselineDist) baselineDist = d;

    const factor = THREE.MathUtils.clamp(d / baselineDist, 0.4, 3.0);
    targetScale = baseScale * factor;

    document.getElementById("debug").innerText =
      `Scale ${factor.toFixed(2)}×`;
  } else {
    dotL.style.display = dotR.style.display = "none";
    baselineDist = null;
    document.getElementById("debug").innerText = "Show two hands";
  }

  requestAnimationFrame(trackHands);
}

/* ───────── ANIMATION LOOP ───────── */

function animate() {
  smoothScale += (targetScale - smoothScale) * 0.15;

  if (model) {
    model.scale.setScalar(smoothScale);
    model.rotation.y += 0.003; // gentle auto-rotate
  }

  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

initHands();

addEventListener("resize", ()=>{
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</body>
</html>
